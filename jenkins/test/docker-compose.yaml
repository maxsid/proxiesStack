version: '3'
services:
  working-web:
    image: nginx:1.17.6
    volumes:
      - "./check-page:/usr/share/nginx/html:ro"
    networks:
      - inner
  not-working-web:
    image: nginx:1.17.6
    networks:
      - inner
  grab-page-web:
    image: nginx:1.17.6
    volumes:
      - "./grab-page:/usr/share/nginx/html:ro"
    networks:
      - inner
  working-proxy:
    image: mockserver/mockserver:mockserver-5.8.0
    environment:
      LOG_LEVEL: "DEBUG"
      SERVER_PORT: 1080
      PROXY_REMOTE_PORT: 80
      PROXY_REMOTE_HOST: working-web
    depends_on:
      - working-web
    networks:
      inner:
        aliases:
          - foo.com
          - bar.com
  not-working-proxy:
    image: mockserver/mockserver:mockserver-5.8.0
    environment:
      LOG_LEVEL: "DEBUG"
      SERVER_PORT: 1090
      PROXY_REMOTE_PORT: 80
      PROXY_REMOTE_HOST: not-working-web   
    depends_on:
      - not-working-web
    networks:
      inner:
        aliases:
          - foo.net
          - bar.net
  proxies-redis:
    image: redis:5.0.7
    networks:
      - inner
  proxies-stack:
    image: "${DOCKER_REPOSITORY}/proxies-stack:${BUILD_NUMBER}"
    environment:
      CHECK_ADDRESS: "http://proxies-service.com"
      CHECK_PATTERN: "<form.+?id=\"get-code\">"
      GRAB_ADDRESS: "http://proxies-list.com"
      REIDS_HOST: "proxies-redis:6379"
    networks:
      - inner
    depends_on:
      - proxies-redis
      - working-proxy
      - not-working-proxy
  python-tester:
    build: ./tester
    depends_on:
      - proxies-stack
    networks:
      - inner
networks:
  inner: